(()=>{let vehicles=[];let selectedVehicle=null;let activeFilter={type:"all",value:null};let searchTerm="";let locales={};let IMG_LINK=null;const $=(s,root=document)=>root.querySelector(s);const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));const DEFAULT_IMG="img/default.png";const LOCAL_DIR="img/vehicles/";const EXTENSIONS=["jpg","png","webp"];const NAME_VARIANTS=(name)=>[name,name?.toLowerCase?.()??name];const ensureTrailingSlash=(s)=>(s.endsWith("/")?s:s+"/");function buildImageCandidates(v){const list=[];if(v.image&&typeof v.image==="string")list.push(v.image);const names=NAME_VARIANTS(v.name||v.label||"");if(IMG_LINK&&typeof IMG_LINK==="string"&&IMG_LINK.trim().length){const base=ensureTrailingSlash(IMG_LINK.trim());for(const n of names){for(const ext of EXTENSIONS){list.push(`${base}${n}.${ext}`)}}}
for(const n of names){for(const ext of EXTENSIONS){list.push(`${LOCAL_DIR}${n}.${ext}`)}}
list.push(DEFAULT_IMG);return Array.from(new Set(list))}
function createImageWithFallback(candidates,alt="vehicle"){const img=new Image();img.className="vehicle-img";img.alt=alt;let idx=0;const tryNext=()=>{if(idx>=candidates.length)return;const nextSrc=candidates[idx++];if(img.src===nextSrc)return tryNext();img.src=nextSrc};img.onerror=()=>{img.onerror=null;img.onerror=()=>tryNext();tryNext()};tryNext();return img}
const hexToRgb=(hex)=>{const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:255,g:255,b:255}};const rgbToHex=(r,g,b)=>"#"+[r,g,b].map(v=>v.toString(16).padStart(2,"0")).join("");const randomColor=()=>({r:Math.floor(Math.random()*256),g:Math.floor(Math.random()*256),b:Math.floor(Math.random()*256)});const capitalize=s=>s?s[0].toUpperCase()+s.slice(1):s;const PLATE_STYLES={plate01:{file:"img/plates/plate01.png",text:"#002a7a"},plate02:{file:"img/plates/plate02.png",text:"#bcd3ff"},plate03:{file:"img/plates/plate03.png",text:"#1d3c7a"},plate04:{file:"img/plates/plate04.png",text:"#001b5e"},plate05:{file:"img/plates/plate05.png",text:"#1a1a1a"},yankton:{file:"img/plates/yankton_plate.png",text:"#0e2f7a"}};function updateUI(){const headerTitle=$(".menu-header h2");const spanSelected=$(".meta-line span:nth-child(1)");const spanCategory=$(".meta-line span:nth-child(2)");const spanPlate=$(".meta-line span:nth-child(3)");const bSelected=$("#selected-vehicle");const bCategory=$("#current-category");const bPlate=$("#current-plate");const searchInput=$("#search-input");const pickColorBtn=$("#pick-color");const randomColorBtn=$("#random-color");const rgbValues=$("#rgb-values");const customPlateToggle=$("#custom-plate-toggle");const platePanelTitle=$(".plate-title");const plateInput=$("#plate-text");const plateRandomBtn=$("#plate-random");const plateStyleBtns=$$(".btn-choice[data-plate-style]");const spawnBtn=$("#spawn-btn");const randomVehicleBtn=$("#random-vehicle");const closeMenuBtn=$("#close-menu");if(!locales)return;if(headerTitle)headerTitle.textContent=locales.vm_title||"Vehicle Menu";if(spanSelected)spanSelected.innerHTML=`${locales.vm_selected || "Selected"}: <b id="selected-vehicle">${locales.vm_none || "None"}</b>`;if(spanCategory)spanCategory.innerHTML=`${locales.vm_category || "Category"}: <b id="current-category">${locales.vm_all || "All"}</b>`;if(spanPlate)spanPlate.innerHTML=`${locales.vm_plate || "Plate"}: <b id="current-plate">${locales.vm_random || "Random"}</b>`;if(searchInput)searchInput.placeholder=locales.vm_search_placeholder||"Search vehicles...";if(pickColorBtn)pickColorBtn.innerHTML=`<i class="fa-solid fa-palette"></i> ${locales.vm_pick_color || "Pick Color"}`;if(randomColorBtn)randomColorBtn.innerHTML=`<i class="fa-solid fa-shuffle"></i> ${locales.vm_random_color || "Random color"}`;if(rgbValues)rgbValues.textContent=(locales.vm_rgb_format||"RGB(%d, %d, %d)").replace("%d, %d, %d","255, 255, 255");if(customPlateToggle)customPlateToggle.innerHTML=`<i class="fa-solid fa-id-card"></i> ${locales.vm_custom_plate || "Custom Plate"}`;if(platePanelTitle)platePanelTitle.textContent=locales.vm_custom_plate||"Custom Plate";if(plateInput)plateInput.placeholder=locales.vm_plate_input_placeholder||"PLATE";if(plateRandomBtn)plateRandomBtn.innerHTML=`<i class="fa-solid fa-shuffle"></i> ${locales.vm_plate_random_btn || "Random plate"}`;const plateKeys=["vm_plate_style_plate01","vm_plate_style_plate02","vm_plate_style_plate03","vm_plate_style_plate04","vm_plate_style_plate05","vm_plate_style_yankton"];plateStyleBtns.forEach((btn,i)=>{const key=plateKeys[i];if(key&&locales[key])btn.textContent=locales[key]});if(spawnBtn)spawnBtn.innerHTML=`<i class="fa-solid fa-check"></i> ${locales.vm_spawn || "Spawn"}`;if(randomVehicleBtn)randomVehicleBtn.innerHTML=`<i class="fa-solid fa-shuffle"></i> ${locales.vm_random_vehicle || "Random"}`;if(closeMenuBtn)closeMenuBtn.innerHTML=`<i class="fa-solid fa-xmark"></i> ${locales.vm_close || "Close"}`}
function uniqueCategories(list){const s=new Set(list.map(v=>v.category).filter(Boolean));return Array.from(s).sort((a,b)=>String(a).localeCompare(String(b)))}
function setCategories(raw){const wrap=$("#category-container");if(!wrap)return;wrap.innerHTML="";const addBtn=(key,label,type="category")=>{const btn=document.createElement("button");btn.className="category-btn";btn.dataset.category=key;btn.textContent=label;btn.addEventListener("click",()=>{if(type==="all")activeFilter={type:"all",value:null};else if(type==="favorites")activeFilter={type:"favorites",value:null};else activeFilter={type:"category",value:key};applyFilter(!0)});wrap.appendChild(btn)};addBtn("all",locales.vm_all||"All","all");addBtn("favorites",locales.vm_favorites||"Favorites","favorites");const cats=raw&&raw.length?raw:uniqueCategories(vehicles);cats.forEach(c=>addBtn(c,capitalize(c)));applyFilter(!0)}
function updateCategoryLabel(){const el=$("#current-category");if(!el)return;if(activeFilter.type==="all")el.textContent=locales.vm_all||"All";else if(activeFilter.type==="favorites")el.textContent=locales.vm_favorites||"Favorites";else el.textContent=capitalize(activeFilter.value||"")}
function filteredVehicles(){let list=vehicles;if(activeFilter.type==="favorites")list=list.filter(v=>v.favorite);if(activeFilter.type==="category"&&activeFilter.value)list=list.filter(v=>v.category===activeFilter.value);if(searchTerm){const q=searchTerm.toLowerCase();list=list.filter(v=>(v.label||"").toLowerCase().includes(q)||(v.name||"").toLowerCase().includes(q))}
return list}
const BATCH_SIZE=30;let currentList=[];let renderedCount=0;function clearVehicleList(container){container.innerHTML="";renderedCount=0}
function appendBatch(container){const end=Math.min(renderedCount+BATCH_SIZE,currentList.length);for(let i=renderedCount;i<end;i++){const v=currentList[i];const card=document.createElement("div");card.className="vehicle-card";if(selectedVehicle&&selectedVehicle.name===v.name)card.classList.add("selected");const candidates=buildImageCandidates(v);const img=createImageWithFallback(candidates,v.name||"vehicle");const info=document.createElement("div");info.className="vehicle-info";info.innerHTML=`<div class="vehicle-label">${v.label||v.name}</div><div class="vehicle-name">${v.name||""}</div>`;const fav=document.createElement("button");fav.className="favorite-btn";fav.innerHTML=v.favorite?"★":"<span class='off'>☆</span>";fav.addEventListener("click",(e)=>{e.stopPropagation();v.favorite=!v.favorite;fetch(`https://${GetParentResourceName()}/toggleFavorite`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:v.name,favorite:v.favorite})});fav.innerHTML=v.favorite?"★":"<span class='off'>☆</span>"});card.addEventListener("click",()=>{selectedVehicle=v;const sel=$("#selected-vehicle");if(sel)sel.textContent=v.label||v.name;$$(".vehicle-card").forEach(c=>c.classList.remove("selected"));card.classList.add("selected");refreshActionsState()});card.append(img,info,fav);container.appendChild(card)}
renderedCount=end}
function renderVehicleList(list){const container=$("#vehicle-list");if(!container)return;clearVehicleList(container);currentList=list;if(!list.length){const msg=document.createElement("div");msg.className="empty-message";msg.textContent=locales.vm_no_vehicles||"No vehicles";container.appendChild(msg);container.onscroll=null;return}
appendBatch(container);container.onscroll=()=>{if(container.scrollTop+container.clientHeight>=container.scrollHeight-20){if(renderedCount<currentList.length){appendBatch(container)}}}}
function applyFilter(force=!1){$$(".category-btn").forEach(b=>b.classList.remove("active"));const key=activeFilter.type==="all"?"all":activeFilter.type==="favorites"?"favorites":activeFilter.value;const btn=$(`.category-btn[data-category="${key}"]`);if(btn)btn.classList.add("active");renderVehicleList(filteredVehicles());updateCategoryLabel()}
const colorInput=$("#color-input");const rgbOut=$("#rgb-values");const swatch=$("#color-swatch");function setColorFromHex(hex){const{r,g,b}=hexToRgb(hex);if(rgbOut)rgbOut.textContent=(locales.vm_rgb_format||"RGB(%d, %d, %d)").replace("%d, %d, %d",`${r}, ${g}, ${b}`);if(swatch){swatch.style.background=hex;swatch.title=hex.toUpperCase()}}
$("#pick-color")?.addEventListener("click",()=>colorInput?.click());colorInput?.addEventListener("input",e=>setColorFromHex(e.target.value));$("#random-color")?.addEventListener("click",()=>{const c=randomColor();const hex=rgbToHex(c.r,c.g,c.b);if(colorInput)colorInput.value=hex;setColorFromHex(hex)});function randomPlateText(len=8){const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let out="";for(let i=0;i<len;i++)out+=chars[Math.floor(Math.random()*chars.length)];return out}
const PLATE_MASK=/[^A-Z0-9]/g;function sanitizePlateInputValue(){const input=$("#plate-text");if(!input)return"";const cleaned=(input.value||"").toUpperCase().replace(PLATE_MASK,"").slice(0,8);if(cleaned!==input.value)input.value=cleaned;return cleaned}
function updatePlateCounter(){const input=$("#plate-text");const counter=$("#plate-count");if(input&&counter){const len=(input.value||"").length;counter.textContent=locales.vm_plate_counter_format?locales.vm_plate_counter_format.replace("%d",len):`${len}/8`}}
function updatePlatePreview(){const styleBtn=$(".btn-choice.active[data-plate-style]");const key=styleBtn?.dataset.plateStyle||"plate01";const conf=PLATE_STYLES[key]||PLATE_STYLES.plate01;const img=$("#plate-preview-img");const textEl=$("#plate-preview-text");const val=sanitizePlateInputValue();if(img)img.src=conf.file;if(textEl){textEl.style.color=conf.text;textEl.textContent=val.length?val:"PLATE"}
updatePlateCounter()}
function updateSelectedPlate(){const el=$("#current-plate");if(!el)return;const plate=getPlatePayload();if(plate&&plate.text)el.textContent=plate.text;else el.textContent=locales.vm_random||"Random"}
function initPlateRow(){const row=$(".plate-row");const input=$("#plate-text");if(row&&input&&!$(".plate-input-wrap")){const wrap=document.createElement("div");wrap.className="plate-input-wrap";row.insertBefore(wrap,input);wrap.appendChild(input);const counter=document.createElement("span");counter.id="plate-count";counter.className="plate-count";wrap.appendChild(counter)}
const rnd=$("#plate-random");if(rnd)rnd.classList.add("btn-choice");}
$("#plate-text")?.addEventListener("beforeinput",e=>{if(e.data&&/[^a-zA-Z0-9]/.test(e.data))e.preventDefault();});$("#plate-text")?.addEventListener("input",()=>{updatePlatePreview();updateSelectedPlate()});$("#plate-text")?.addEventListener("paste",e=>{e.preventDefault();const text=(e.clipboardData.getData("text")||"").toUpperCase().replace(PLATE_MASK,"").slice(0,8);const input=$("#plate-text");if(input)input.value=text;updatePlatePreview();updateSelectedPlate()});$("#plate-random")?.addEventListener("click",()=>{const input=$("#plate-text");if(!input)return;input.value=randomPlateText();updatePlatePreview();updateSelectedPlate()});$$(".btn-choice[data-plate-style]").forEach(b=>{b.addEventListener("click",()=>{$$(".btn-choice[data-plate-style]").forEach(x=>x.classList.remove("active"));b.classList.add("active");updatePlatePreview();updateSelectedPlate()})});function getPlatePayload(){const toggle=$("#custom-plate-toggle");if(!toggle||!toggle.classList.contains("active"))return null;const text=sanitizePlateInputValue();if(!text)return null;const styleBtn=$(".btn-choice.active[data-plate-style]");const styleKey=styleBtn?.dataset.plateStyle||"plate01";return{text,style:styleKey}}
function positionPlatePanel(){const panel=$("#plate-panel");const menu=$(".vehicle-menu");if(!panel||!menu||!panel.classList.contains("is-open"))return;const gap=16;const mr=menu.getBoundingClientRect();const pr=panel.getBoundingClientRect();let left=mr.right+gap;let top=mr.top+(mr.height-pr.height)/2;left=Math.min(left,window.innerWidth-pr.width-gap);top=Math.max(gap,Math.min(top,window.innerHeight-pr.height-gap));panel.style.left=left+"px";panel.style.top=top+"px";panel.style.right="auto";panel.style.transform="none"}
function openPlatePanel(){const panel=$("#plate-panel");if(!panel)return;panel.classList.add("is-open");initPlateRow();updatePlatePreview();updateSelectedPlate();requestAnimationFrame(positionPlatePanel)}
function closePlatePanel(){const panel=$("#plate-panel");if(panel)panel.classList.remove("is-open");updateSelectedPlate()}
$("#custom-plate-toggle")?.addEventListener("click",e=>{const btn=e.currentTarget;btn.classList.toggle("active");if(btn.classList.contains("active"))openPlatePanel();else closePlatePanel()});$("#plate-close")?.addEventListener("click",()=>{$("#custom-plate-toggle")?.classList.remove("active");closePlatePanel()});window.addEventListener("resize",positionPlatePanel);function spawnSelected(){if(!selectedVehicle)return;const{r,g,b}=hexToRgb(colorInput?.value||"#ffffff");const payload={name:selectedVehicle.name,color:{r,g,b}};const plate=getPlatePayload();if(plate)payload.plate=plate;fetch(`https://${GetParentResourceName()}/spawnVehicle`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)})}
function refreshActionsState(){const spawnBtn=$("#spawn-btn");const disabled=!selectedVehicle;[spawnBtn].forEach(b=>{if(!b)return;b.disabled=disabled;b.classList.toggle("is-disabled",disabled)})}
function requestRandomVehicle(){fetch(`https://${GetParentResourceName()}/randomVehicle`,{method:"POST"})}
function showMenu(){$(".vehicle-menu")?.style.setProperty("display","flex")}
function hideMenu(){$(".vehicle-menu")?.style.setProperty("display","none");$("#custom-plate-toggle")?.classList.remove("active");closePlatePanel()}
$("#spawn-btn")?.addEventListener("click",spawnSelected);$("#random-vehicle")?.addEventListener("click",requestRandomVehicle);$("#close-menu")?.addEventListener("click",()=>{fetch(`https://${GetParentResourceName()}/close`,{method:"POST"});hideMenu()});$("#search-input")?.addEventListener("input",e=>{searchTerm=e.target.value.trim();applyFilter(!0)});window.addEventListener("message",(event)=>{const d=event.data||{};switch(d.action){case "showMenu":locales=d.locales||{};IMG_LINK=(typeof d.imgLink==="string"&&d.imgLink.trim().length)?d.imgLink:null;updateUI();vehicles=(d.vehicles||[]).map(v=>({...v}));setCategories(Array.isArray(d.categories)?d.categories:uniqueCategories(vehicles));selectedVehicle=null;if($("#selected-vehicle"))$("#selected-vehicle").textContent=locales.vm_none||"None";if($("#current-plate"))$("#current-plate").textContent=locales.vm_random||"Random";showMenu();applyFilter(!0);refreshActionsState();break;case "hideMenu":hideMenu();break;case "setVehicles":vehicles=(d.vehicles||[]).map(v=>({...v}));selectedVehicle=null;if($("#selected-vehicle"))$("#selected-vehicle").textContent=locales.vm_none||"None";setCategories(d.categories||uniqueCategories(vehicles));applyFilter(!0);refreshActionsState();break;case "setCategories":setCategories(d.categories||uniqueCategories(vehicles));break;case "setLocales":locales=d.locales||{};updateUI();updateCategoryLabel();break;case "setImgLink":IMG_LINK=(typeof d.imgLink==="string"&&d.imgLink.trim().length)?d.imgLink:null;applyFilter(!0);break}});if(colorInput)setColorFromHex(colorInput.value||"#ffffff");if($("#current-plate"))$("#current-plate").textContent="Random";applyFilter(!0)})()